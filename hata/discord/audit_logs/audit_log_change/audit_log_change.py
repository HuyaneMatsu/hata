__all__ = ('AuditLogChange', )

from scarletio import RichAttributeErrorBaseType

from ..conversion_helpers.helpers import _hash_change_value

from .fields import validate_attribute_name
from .flags import FLAG_HAS_AFTER, FLAG_HAS_BEFORE


class AuditLogChange(RichAttributeErrorBaseType):
    """
    A change of an ``AuditLogEntry``.
    
    Attributes
    ----------
    after : `object`
        The changed attribute's new value. Defaults to `None`.
    
    attribute_name : `str`
        The name of the changed attribute.
    
    before : `object`
        The changed attribute's original value. Defaults to `None`.
    
    flags : `int`
        Bitwise flags containing additional details.
    
    Notes
    -----
    The type of `before` and `after` is depending on the value of `attribute_name`.
    
    For application commands:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | permission_overwrites                 | ``None | tuple<ApplicationCommandPermissionOverwrite>``   |
    +---------------------------------------+-----------------------------------------------------------+
    
    For auto moderation rules:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | actions                               | ``None | tuple<AutoModerationAction>                      |
    +---------------------------------------+-----------------------------------------------------------+
    | creator_id                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | enabled                               | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | excluded_keywords                     | ``None | tuple<str>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | event_type                            | ``None | AutoModerationEventType``                        |
    +---------------------------------------+-----------------------------------------------------------+
    | excluded_channel_ids                  | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | excluded_role_ids                     | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | keywords                              | ``None | tuple<str>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | mention_limit                         | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | raid_protection                       | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | regex_patterns                        | ``None | tuple<str>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | trigger_metadata                      | ``None | AutoModerationRuleTriggerMetadataBase``          |
    +---------------------------------------+-----------------------------------------------------------+
    | trigger_type                          | ``None | AutoModerationRuleTriggerType``                  |
    +---------------------------------------+-----------------------------------------------------------+
    | permission_overwrites                 | ``None | dict<int, PermissionOverwrite>``                 |
    +---------------------------------------+-----------------------------------------------------------+
    
    For channels:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | applied_tag_ids                       | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | archived                              | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | auto_archive_duration                 | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | available_tags                        | ``None | tuple<ForumTag>``                                |
    +---------------------------------------+-----------------------------------------------------------+
    | bitrate                               | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | default_thread_auto_archive_after     | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | default_forum_layout                  | ``None | ForumLayout``                                    |
    +---------------------------------------+-----------------------------------------------------------+
    | default_sort_order                    | ``None | SortOrder``                                      |
    +---------------------------------------+-----------------------------------------------------------+
    | default_thread_reaction_emoji         | ``None | Emoji``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    | default_thread_slowmode               | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | flags                                 | ``None``, ChannelFlag``                                   |
    +---------------------------------------+-----------------------------------------------------------+
    | invitable                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | nsfw                                  | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | open                                  | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | parent_id                             | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | position                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | region                                | ``None | VoiceRegion``                                    |
    +---------------------------------------+-----------------------------------------------------------+
    | slowmode                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | topic                                 | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | type                                  | ``None | ChannelType````                                  |
    +---------------------------------------+-----------------------------------------------------------+
    | video_quality_mode                    | ``None | VideoQualityMode``                               |
    +---------------------------------------+-----------------------------------------------------------+
    | user_limit                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    
    For channel permission overwrites:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | allow                                 | ``None | Permission``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | deny                                  | ``None | Permission``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | target_id                             | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | target_type                           | ``None | PermissionOverwriteTargetType``                  |
    +---------------------------------------+-----------------------------------------------------------+
    
    For emojis:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | available                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | role_ids                              | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    
    For guilds:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | activity_application_ids              | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | afk_channel_id                        | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | afk_timeout                           | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | banner                                | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | banner_color                          | ``None | Color``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    | boost_progress_bar_enabled            | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | default_message_notification_level    | ``None | MessageNotificationLevel``                       |
    +---------------------------------------+-----------------------------------------------------------+
    | description                           | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | discovery_splash                      | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | explicit_content_filter_level         | ``None | ExplicitContentFilterLevel``                     |
    +---------------------------------------+-----------------------------------------------------------+
    | hub_type                              | ``None | HubType``                                        |
    +---------------------------------------+-----------------------------------------------------------+
    | icon                                  | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | invite_splash                         | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | locale                                | ``None | Locale``                                         |
    +---------------------------------------+-----------------------------------------------------------+
    | max_stage_channel_video_users         | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | max_voice_channel_video_users         | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | mfa_level                             | ``None | MfaLevel``                                       |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | nsfw_level                            | ``None | NsfwLevel``                                      |
    +---------------------------------------+-----------------------------------------------------------+
    | owner_id                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | privacy_level                         | ``None | PrivacyLevel``                                   |
    +---------------------------------------+-----------------------------------------------------------+
    | public_updates_channel_id             | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | rules_channel_id                      | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | safety_alerts_channel_id              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | system_channel_flags                  | ``None | SystemChannelFlag``                              |
    +---------------------------------------+-----------------------------------------------------------+
    | system_channel_id                     | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | tags                                  | ``None | tuple<GuildActivityOverviewTag>``                |
    +---------------------------------------+-----------------------------------------------------------+
    | vanity_code                           | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | verification_level                    | ``None | VerificationLevel``                              |
    +---------------------------------------+-----------------------------------------------------------+
    | widget_channel_id                     | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | widget_enabled                        | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    
    For integrations:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | emojis_enabled                        | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | expire_behavior                       | ``None | IntegrationExpireBehavior``                      |
    +---------------------------------------+-----------------------------------------------------------+
    | expire_grace_period                   | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | type                                  | ``None | IntegrationType``                                |
    +---------------------------------------+-----------------------------------------------------------+
    
    For invites:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | channel_id                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | code                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | flags                                 | ``None | InviteFlag``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | inviter_id                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | max_age                               | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | max_uses                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | temporary                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | uses                                  | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    
    For onboarding prompts:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | in_onboarding                         | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | options                               | ``None | tuple<OnboardingPromptOption>``                  |
    +---------------------------------------+-----------------------------------------------------------+
    | required                              | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | single_select                         | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | type                                  | ``None | OnboardingPromptType``                           |
    +---------------------------------------+-----------------------------------------------------------+
    
    For onboarding screen:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | default_channel_ids                   | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | enabled                               | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | mode                                  | ``None | OnboardingMode``                                 |
    +---------------------------------------+-----------------------------------------------------------+
    | prompts                               | ``None | tuple<OnboardingPrompt>``                        |
    +---------------------------------------+-----------------------------------------------------------+
    
    For roles:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | color                                 | ``None | Color``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    | flags                                 | ``None | RoleFlag``                                       |
    +---------------------------------------+-----------------------------------------------------------+
    | icon                                  | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | mentionable                           | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | permissions                           | ``None | Permission``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | position                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | separated                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | unicode_emoji                         | ``None | Emoji``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    
    For scheduled events:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | channel_id                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | description                           | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | end                                   | ``None | DateTime``                                       |
    +---------------------------------------+-----------------------------------------------------------+
    | entity_id                             | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | entity_metadata                       | ``None | ScheduledEventEntityMetadataBase``               |
    +---------------------------------------+-----------------------------------------------------------+
    | entity_type                           | ``None | ScheduledEventEntityType``                       |
    +---------------------------------------+-----------------------------------------------------------+
    | image                                 | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | location                              | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | privacy_level                         | ``None | PrivacyLevel``                                   |
    +---------------------------------------+-----------------------------------------------------------+
    | sku_ids                               | ``None | tuple<int>``                                     |
    +---------------------------------------+-----------------------------------------------------------+
    | start                                 | ``None | DateTime``                                       |
    +---------------------------------------+-----------------------------------------------------------+
    | status                                | ``None | ScheduledEventStatus``                           |
    +---------------------------------------+-----------------------------------------------------------+
    
    For soundboard sounds:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | available                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | emoji                                 | ``None | Emoji``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    | id                                    | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | user_id                               | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | volume                                | ``None | float``                                          |
    +---------------------------------------+-----------------------------------------------------------+
    
    For stages:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | privacy_level                         | ``None | PrivacyLevel``                                   |
    +---------------------------------------+-----------------------------------------------------------+
    | topic                                 | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    
    For stickers:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | available                             | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | description                           | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | format                                | ``None | StickerFormat``                                  |
    +---------------------------------------+-----------------------------------------------------------+
    | guild_id                              | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | id                                    | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | sort_value                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | tags                                  | ``None | frozenset<str>``                                 |
    +---------------------------------------+-----------------------------------------------------------+
    | type                                  | ``None | StickerType``                                    |
    +---------------------------------------+-----------------------------------------------------------+
    
    For users:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | avatar                                | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | bypasses_verification                 | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | deaf                                  | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | flags                                 | ``None | GuildProfileFlag``                               |
    +---------------------------------------+-----------------------------------------------------------+
    | mute                                  | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | nick                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | pending                               | ``None | bool``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | roles                                 | ``None | tuple<AuditLogRole>``                            |
    +---------------------------------------+-----------------------------------------------------------+
    | timed_out_until                       | ``None | DateTime``                                       |
    +---------------------------------------+-----------------------------------------------------------+
    
    # For webhooks:
    
    +---------------------------------------+-----------------------------------------------------------+
    | Attribute name                        | before / after                                            |
    +=======================================+===========================================================+
    | application_id                        | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | avatar                                | ``None | Icon``                                           |
    +---------------------------------------+-----------------------------------------------------------+
    | channel_id                            | ``None | int``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | name                                  | ``None | str``                                            |
    +---------------------------------------+-----------------------------------------------------------+
    | type                                  | ``None``, ``WebhookType``                                 |
    +---------------------------------------+-----------------------------------------------------------+
    """
    __slots__ = ('after', 'attribute_name', 'before', 'flags')
    
    def __new__(cls, attribute_name, *, before = ..., after = ...):
        """
        Creates a new audit log change instance.
        
        Parameters
        ----------
        attribute_name : `str`
            The name of the changed attribute.
        
        after : `object`
            The changed attribute's new value.
        
        before : `object`, Optional (Keyword only)
            The changed attribute's original value.
        
        Raises
        ------
        TypeError
            - If a parameter's type is incorrect.
        ValueError
            - If a parameter's value is incorrect.
        """
        attribute_name = validate_attribute_name(attribute_name)
        flags = 0
        
        # after
        if after is ...:
            after = None
        else:
            flags |= FLAG_HAS_AFTER
        
        # before
        if before is ...:
            before = None
        else:
            flags |= FLAG_HAS_BEFORE
        
        # Construct
        self = object.__new__(cls)
        self.after = after
        self.attribute_name = attribute_name
        self.before = before
        self.flags = flags
        return self
    
    
    @classmethod
    def create_clean(cls, attribute_name):
        """
        Creates a new clean audit log instance.
        Not like ``.__new__`` this skips validations and only accepts `attribute_name`. For internal use only.
        

        Parameters
        ----------
        attribute_name : `str`
            The name of the changed attribute.
        
        Returns
        -------
        self : `instance<cls>`
        """
        # Construct
        self = object.__new__(cls)
        self.after = None
        self.attribute_name = attribute_name
        self.before = None
        self.flags = 0
        return self
    
    
    @classmethod
    def from_fields(cls, attribute_name, flags, before, after):
        """
        Creates a new audit log change instance.
        Not like ``.__new__`` this has no validations. For internal use only.
        
        Parameters
        ----------
        attribute_name : `str`
            The name of the changed attribute.
        after : `object`
            The changed attribute's new value.
        before : `object`
            The changed attribute's original value.
        flags : `int`
            Bitwise flags containing additional details.
        
        Returns
        -------
        self : `instance<cls>`
        """
        self = object.__new__(cls)
        self.after = after
        self.attribute_name = attribute_name
        self.before = before
        self.flags = flags
        return self
    
    
    def __repr__(self):
        """Returns the representation of the audit log change."""
        repr_parts = ['<', type(self).__name__]
        
        # attribute_name
        repr_parts.append(' attribute_name = ')
        repr_parts.append(repr(self.attribute_name))
        
        flags = self.flags
        if flags & FLAG_HAS_BEFORE:
            repr_parts.append(', before = ')
            repr_parts.append(repr(self.before))
        
        if flags & FLAG_HAS_AFTER:
            repr_parts.append(', after = ')
            repr_parts.append(repr(self.after))
        
        repr_parts.append('>')
        return ''.join(repr_parts)
    
    
    def __eq__(self, other):
        """Returns whether the two audit log changes are equal."""
        if type(self) is not type(other):
            return NotImplemented
        
        # attribute_name
        if self.attribute_name != other.attribute_name:
            return False
        
        # flags
        if self.flags != other.flags:
            return False
        
        # before
        if self.before != other.before:
            return False
        
        # after
        if self.after != other.after:
            return False
        
        return True
    
    
    def __hash__(self):
        """Returns the hash value of the audit log change."""
        hash_value = 0
        
        # attribute_name
        hash_value ^= hash(self.attribute_name)
        
        # flags
        hash_value ^= hash(self.flags)
        
        # before
        hash_value ^= _hash_change_value(self.before)
        
        # after
        hash_value ^= _hash_change_value(self.after)
        
        return hash_value
    
    
    def has_before(self):
        """
        Returns whether the change has `before` value.
        
        Returns
        -------
        has_before : `bool`
        """
        return True if self.flags & FLAG_HAS_BEFORE else False
    
    
    def has_after(self):
        """
        Returns whether the change has `after` value.
        
        Returns
        -------
        has_after : `bool`
        """
        return True if self.flags & FLAG_HAS_AFTER else False
